(function(){"use strict";function I(o,t){let e=o<0n?-o:o,n=t<0n?-t:t;for(;n!==0n;){const r=e%n;e=n,n=r}return e}function w(o,t){let e=o,n=t,r=1n,i=0n,s=0n,c=1n;for(;n!==0n;){const l=e/n,a=e-l*n;e=n,n=a;const p=r-l*i;r=i,i=p;const d=s-l*c;s=c,c=d}return e<0n&&(e=-e,r=-r,s=-s),{gcd:e,x:r,y:s}}function h(o,t){if(t===0n)throw new Error("Modulus m must be non-zero.");const e=t<0n?-t:t,{gcd:n,x:r}=w(o,e);if(n!==1n)throw new Error("Inverse does not exist (a and m are not coprime).");return(r%e+e)%e}const m=(o,t)=>(o-1n)*(t-1n),E=5e6,u=2n*3n*5n*7n*11n,g=(()=>{const o=[];let t=1n;for(;t<u;)I(t,u)===1n&&o.push(t),t+=1n;return o})(),b=(o,t,e)=>{o.attempts%e===0&&t(o.attempts)},y=(o,t,e,n,r,i)=>{t<=1n&&(t=2n);let s=t/u*u,c=0;for(;c<g.length&&s+g[c]<t;)c+=1;for(c>=g.length&&(s+=u,c=0);;){for(let l=c;l<g.length;l+=1){const a=s+g[l];if(e!==null&&a>=e||a*a>o)return null;if(n.attempts+=1,b(n,r,i),o%a===0n)return a}s+=u,c=0}},x=({n:o,startInclusive:t,endExclusive:e,onHeartbeat:n,heartbeatBatchSize:r=E})=>{const i={attempts:0},s=y(o,t,e,i,n,r);return s!==null?{p:s,q:o/s}:(n(i.attempts),null)},f=self;f.onmessage=o=>{const t=o.data;if(t.type==="recover")try{const e=BigInt(t.n),n=BigInt(t.start),r=typeof t.endExclusive=="string"&&t.endExclusive.trim()!==""?BigInt(t.endExclusive):null;if(e<=1n)throw new Error("n must be greater than 1.");if(n<=1n)throw new Error("Invalid recovery range.");if(r!==null&&r<=n){const d={type:"not_found",jobId:t.jobId,workerId:t.workerId};f.postMessage(d);return}const i=x({n:e,startInclusive:n,endExclusive:r,onHeartbeat:d=>{const k={type:"heartbeat",jobId:t.jobId,workerId:t.workerId,attempts:d};f.postMessage(k)}});if(!i){const d={type:"not_found",jobId:t.jobId,workerId:t.workerId};f.postMessage(d);return}const s=i.p,c=i.q,l=m(s,c);let a="";if(typeof t.e=="string"&&t.e.trim()!==""){const d=BigInt(t.e);d>1n&&d<e&&I(d,l)===1n&&(a=h(d,l).toString())}const p={type:"completed",jobId:t.jobId,workerId:t.workerId,p:s.toString(),q:c.toString(),phi:l.toString(),d:a};f.postMessage(p)}catch(e){const n={type:"error",jobId:t.jobId,workerId:t.workerId,message:e instanceof Error?e.message:"Failed to recover RSA key."};f.postMessage(n)}}})();
