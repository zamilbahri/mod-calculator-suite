(function(){"use strict";class d extends Error{fieldNames;reason;expectedValue;constructor(t,e,r){const i=Array.isArray(t)?t:[t],s=r!==void 0?` ${r}`:"";super(`${i.join(", ")} ${e}${s}`),this.name="MathValidationError",this.fieldNames=i,this.reason=e,this.expectedValue=r}}function m(n,t){const e=n%t;return e>=0n?e:e+t}function I(n,t,e){if(t<0n)throw new d("n","must be non-negative.");if(e<=0n)throw new d("m","must be positive.");if(e===1n)return 0n;let r=n%e;r<0n&&(r+=e);let i=t,s=1n;for(;i>0n;)i&1n&&(s=s*r%e),r=r*r%e,i>>=1n;return s}const g=1n<<64n,P=4096,p=1300,R=[{maxBits:1536,maxCount:10,warnAt:11},{maxBits:2048,maxCount:10,warnAt:5},{maxBits:3072,maxCount:4,warnAt:2},{maxBits:4096,maxCount:4,warnAt:1}],S=[2n,3n,5n,7n,11n,13n,17n,19n,23n,29n,31n,37n,41n,43n,47n,53n,59n,61n,67n,71n,73n,79n,83n,89n,97n,101n,103n,107n,109n,113n,127n,131n,137n,139n,149n,151n,157n,163n,167n,173n,179n,181n,191n,193n,197n,199n,211n,223n,227n,229n,233n,239n,241n,251n,257n,263n,269n,271n,277n,281n,283n,293n,307n,311n,313n,317n,331n,337n,347n,349n,353n,359n,367n,373n,379n,383n,389n,397n,401n,409n,419n,421n,431n,433n,439n,443n,449n,457n,461n,463n,467n,479n,487n,491n,499n,503n,509n,521n,523n,541n,547n,557n,563n,569n,571n,577n,587n,593n,599n,601n,607n,613n,617n,619n,631n,641n,643n,647n,653n,659n,661n,673n,677n,683n,691n,701n,709n,719n,727n,733n,739n,743n,751n,757n,761n,769n,773n,787n,797n,809n,811n,821n,823n,827n,829n,839n,853n,857n,859n,863n,877n,881n,883n,887n,907n,911n,919n,929n,937n,941n,947n,953n,967n,971n,977n,983n,991n,997n];function E(n){return n.toString(2).length}function A(n){const t=new Uint8Array(n),e=globalThis.crypto;if(e&&typeof e.getRandomValues=="function")return e.getRandomValues(t),t;for(let r=0;r<n;r++)t[r]=Math.floor(Math.random()*256);return t}function w(n){if(n<=0n)throw new d("upperExclusive","must be positive.");if(n===1n)return 0n;const t=n-1n,e=E(t),r=Math.ceil(e/8),s=255>>r*8-e;for(;;){const o=A(r);o[0]&=s;let c=0n;for(const l of o)c=c<<8n|BigInt(l);if(c<n)return c}}function C(n){if(n<=2n)throw new d("n","must be greater than","3");return w(n)}function M(n,t){if(t<n)throw new d("range","is invalid.");const e=t-n+1n;return n+w(e)}function v(n){let t=n-1n,e=0;for(;(t&1n)===0n;)t>>=1n,e++;return{d:t,s:e}}function y(n,t){if(n<2n)return!1;if(n===2n||n===3n)return!0;if((n&1n)===0n)return!1;const e=m(t,n);if(e===0n)return!0;const{d:r,s:i}=v(n);let s=I(e,r,n);if(s===1n||s===n-1n)return!0;for(let o=1;o<i;o++)if(s=m(s*s,n),s===n-1n)return!0;return!1}function _(n,t=24){const e=new Set,r=n-3n,i=Math.min(t,r>BigInt(Number.MAX_SAFE_INTEGER)?t:Number(r));for(let s=0;s<i;s++){let o;do o=2n+C(n-3n);while(e.has(o));if(e.add(o),!y(n,o))return{isProbablePrime:!1,witness:o}}return{isProbablePrime:!0}}function N(n){return 2*n}function j(n){if(n<0n)return!1;if(n<2n)return!0;let t=n,e=t+1n>>1n;for(;e<t;)t=e,e=e+n/e>>1n;return t*t===n}function T(n,t){if(t<=0n||(t&1n)===0n)return 0;let e=m(n,t),r=t,i=1;for(;e!==0n;){for(;(e&1n)===0n;){e>>=1n;const o=r&7n;(o===3n||o===5n)&&(i=-i)}const s=e;e=r,r=s,(e&3n)===3n&&(r&3n)===3n&&(i=-i),e%=r}return r===1n?i:0}function x(n,t){let e=m(n,t);return(e&1n)!==0n&&(e+=t),e>>1n}function k(n,t,e,r,i){if(r===0n)return{U:0n,V:2n,Qk:1n};const s=m(t,n),o=m(e,n),c=m(i,n),l=r.toString(2);let u=1n,a=s,f=o;for(let h=1;h<l.length;h++)if(u=m(u*a,n),a=m(a*a-2n*f,n),f=m(f*f,n),l[h]==="1"){const X=x(s*u+a,n),H=x(c*u+s*a,n);u=X,a=H,f=m(f*o,n)}return{U:u,V:a,Qk:f}}function O(n){let t=n,e=0;for(;(t&1n)===0n;)t>>=1n,e++;return{d:t,s:e}}function V(n,t,e,r){const{d:i,s}=O(n+1n),o=k(n,e,r,i,t);if(o.U===0n||o.V===0n)return!0;let c=o.V,l=o.Qk;for(let u=1;u<s;u++)if(c=m(c*c-2n*l,n),l=m(l*l,n),c===0n)return!0;return!1}function $(n){if(!y(n,2n)||j(n))return!1;let t=5n;for(;;){const i=T(t,n);if(i===-1)break;if(i===0)return!1;t=t>0n?-(t+2n):-t+2n}const e=1n,r=(1n-t)/4n;return V(n,t,e,r)}function G(n,t=24){const e=typeof t=="number"?"Auto":t.method??"Auto",r=typeof t=="number"?t:t.millerRabinRounds??24,i=Math.max(1,Math.floor(r)),s=()=>({isProbablePrime:!0,verdict:"Prime",method:"Small Prime Check",errorProbabilityExponent:0,rounds:0}),o=a=>({isProbablePrime:!1,verdict:"Composite",method:"Small Prime Check",compositeReason:a,rounds:0});if(n<2n)return o("n < 2");if(n===2n)return s();if((n&1n)===0n)return o("Factor found: 2");for(const a of S.slice(1)){if(n===a)return s();if(n%a===0n)return o(`Factor found: ${a.toString()}`)}if(e==="Baillie-PSW"||e==="Auto"&&n<g){const a=$(n);return{isProbablePrime:a,verdict:a?n<g?"Prime":"Probably Prime":"Composite",method:"Baillie-PSW",errorProbabilityExponent:a?0:void 0,compositeReason:a?void 0:"BPSW test failed",rounds:0}}const c=i,l=_(n,c),u=l.isProbablePrime;return{isProbablePrime:u,verdict:u?"Probably Prime":"Composite",method:"Miller-Rabin",errorProbabilityExponent:u?N(c):void 0,compositeReason:u?void 0:"Miller-Rabin witness found",witness:u?void 0:l.witness,rounds:c}}function U(n,t){return t==="bits"?n:Math.ceil(n*Math.log2(10))}function W(n){return R.find(t=>n<=t.maxBits)??null}function D(n,t,e=1){if(!Number.isInteger(n)||n<=0)return"Prime size must be a positive integer.";if(!Number.isInteger(e)||e<=0)return"Number of primes must be a positive integer.";if(t==="bits"){if(n>P)return`Maximum size is ${P} bits.`;if(n<2)return"Bit size must be at least 2."}if(t==="digits"&&n>p)return`Maximum size is ${p} digits.`;const r=U(n,t),i=W(r);return i?e>i.maxCount?`Maximum number of generated primes at this size is ${i.maxCount}.`:null:`Prime size must be at most ${P} bits (~1233 digits).`}function B(n){return BigInt(`1${"0".repeat(n)}`)}function F(n){const t=1n<<BigInt(n-1),e=(1n<<BigInt(n))-1n;let r=M(t,e);return r|=1n,r|=t,r}function L(n){if(n===1){const i=[2n,3n,5n,7n];return i[Math.floor(Math.random()*i.length)]}const t=B(n-1),e=B(n)-1n;let r=M(t,e);return r|=1n,r}function q(n,t,e){return G(n,{method:t,millerRabinRounds:e}).isProbablePrime}function Q(n,t,e,r,i){let s=0;for(;;){s++,i&&s%32===0&&i(s);const o=t==="bits"?F(n):L(n);if(q(o,e,r))return o}}async function z(n,t,e){const r=n.count??1,i=n.method??"Auto",s=n.millerRabinRounds??24,o=D(n.size,n.sizeType,r);if(o)throw new d("prime generation",o);const c=[];for(let l=0;l<r;l++){const u=Q(n.size,n.sizeType,i,s,a=>e?.(l+1,r,a));c.push(u),t?.(l+1,r,u),await new Promise(a=>setTimeout(a,0))}return c}const b=self;b.onmessage=async n=>{const t=n.data;if(t.type==="generate")try{const e=performance.now();let r=0;const i=await z(t.options,(o,c,l)=>{const u={type:"progress",jobId:t.jobId,completed:o,total:c,prime:l.toString()};b.postMessage(u)},(o,c,l)=>{const u=performance.now();if(u-r<500)return;r=u;const a={type:"heartbeat",jobId:t.jobId,primeIndex:o,total:c,attempts:l};b.postMessage(a)}),s={type:"completed",jobId:t.jobId,elapsedMs:performance.now()-e,primes:i.map(o=>o.toString())};b.postMessage(s)}catch(e){const r={type:"error",jobId:t.jobId,message:e instanceof Error?e.message:"Failed to generate primes."};b.postMessage(r)}}})();
